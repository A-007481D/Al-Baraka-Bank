flowchart TD
%% --- ACTORS ---
    Client((Client))
    Agent((Agent Bancaire))
    Admin((Admin))
    System{Al Baraka API}
    DB[(Database)]

%% --- SCENARIO 7: ADMIN MANAGEMENT ---
    subgraph S7 [Scenario 7: Admin Governance]
        Admin -->|POST /users| CreateAgent["Create Agent Account"]
        Admin -->|PUT /users| ManageUser["Activate/Deactivate User"]
        CreateAgent & ManageUser --> DB
    end

%% --- SCENARIO 1 & 2: ONBOARDING ---
    subgraph S1_2 [Scenario 1 & 2: Client Access]
        Client -->|1. Register| RegForm["Fill: Email, Pass, Name"]
        RegForm -->|Generate Account #| GenAcc["Create Account + User"]
        GenAcc --> DB

        Client -->|2. Login| Login["Auth: Email + Pass"]
        Login -->|Generate Token| JWT["Return JWT Stateless"]
    end

%% --- SCENARIO 3, 4, 5: OPERATIONS ---
    subgraph S3_4_5 [Scenario 3, 4, 5: Transaction Logic]
        JWT --> SelectOp{Select Operation Type}

    %% PATH 1: DEPOSIT (Scenario 3)
        SelectOp -- DEPOSIT --> DepInput["Input Amount X"]
        DepInput --> CheckLimit{Amount > 10,000?}

    %% PATH 2: WITHDRAWAL (Scenario 4)
        SelectOp -- WITHDRAWAL --> WithInput["Input Amount X"]
        WithInput --> CheckBalW{Solde >= X?}
        CheckBalW -- No --> ErrBal["Error: Insufficient Balance"]
        CheckBalW -- Yes --> CheckLimit

    %% PATH 3: TRANSFER (Scenario 5)
        SelectOp -- TRANSFER --> TransInput["Input Amount X + Dest Account"]
        TransInput --> CheckBalT{Solde >= X?}
        CheckBalT -- No --> ErrBal
        CheckBalT -- Yes --> CheckLimit
    end

%% --- THE CRITICAL LOGIC SPLIT ---

%% CASE A: AUTO VALIDATION (<= 10k)
    CheckLimit -- "NO (<= 10k)" --> AutoVal["Scenario A: Auto Validation"]
    AutoVal --> ExecStat["Set Status: EXECUTED"]
    ExecStat --> UpdateBalA["Update Balance Immediately<br/>(Dep: +X, With: -X, Trans: -X/+X)"]
    UpdateBalA --> DB

%% CASE B: MANUAL VALIDATION (> 10k)
    CheckLimit -- "YES (> 10k)" --> ManVal["Scenario B: Manual Validation"]
    ManVal --> PendStat["Set Status: PENDING"]
    PendStat --> DB
    PendStat --> ReqDoc["Response: 202 Upload Required"]

    ReqDoc -->|Client Action| Upload["Upload Justificatif<br/>POST /document"]
    Upload --> SaveFile["Save File PDF/JPG"]
    SaveFile --> DB

%% --- SCENARIO 6: AGENT REVIEW ---
    subgraph S6 [Scenario 6: Agent Validation]
        Agent -->|GET /pending| ViewPend["View Pending Ops + Docs"]
        ViewPend --> Decision{Approve or Reject?}

        Decision -- REJECT --> SetRej["Set Status: REJECTED"]
        SetRej --> NoMov["Solde InchangÃ©"]
        NoMov --> DB

        Decision -- APPROVE --> SetApp["Set Status: EXECUTED"]
        SetApp --> UpdateBalB["Update Balance Now<br/>(Execute Logic delayed)"]
        UpdateBalB --> DB
    end